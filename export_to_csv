#!/usr/bin/env python3

import csv
# Importa√ß√£o CL√ÅSSICA do Debian/Tails: A maioria das classes de controle
# fica diretamente no m√≥dulo 'stem'.
from stem import CircStatus, ControlPort, InvalidRequest 
# import stem.control  <-- REMOVIDO!
# from stem.util import term # N√£o necess√°rio

# Caminho onde o arquivo CSV ser√° salvo
csv_file_path = "/tmp/circuitos_tor.csv" 

print("Tentando conectar √† porta de controle do Tor...")

try:
    # Chama ControlPort diretamente, sem 'stem.control.'
    with ControlPort() as control_port: 
        circuit_data = []
        for circuit in control_port.get_circuits():
            
            if circuit.status == CircStatus.BUILT:
                path_str = " -> ".join(
                    f"{entry.nick} ({entry.fingerprint})" for entry in circuit.path
                )
                
                circuit_info = {
                    "id": circuit.id,
                    "status": circuit.status.name, 
                    "path": path_str,
                    "purpose": circuit.purpose.name, 
                }
                circuit_data.append(circuit_info)

        # Escreve os dados no CSV
        if circuit_data:
            keys = circuit_data[0].keys()
            with open(csv_file_path, 'w', newline='', encoding='utf-8') as output_file:
                dict_writer = csv.DictWriter(output_file, fieldnames=keys)
                dict_writer.writeheader()
                dict_writer.writerows(circuit_data)
            
            print(f"\nüéâ SUCESSO! Circuitos exportados para: {csv_file_path}")
            print(f"Total de circuitos exportados: {len(circuit_data)}")
        else:
            print("\n‚ö†Ô∏è NENHUM circuito Tor 'Built' (constru√≠do) ativo foi encontrado.")

# Chama InvalidRequest diretamente
except InvalidRequest as exc: 
    print(f"\n‚ùå ERRO DE COMUNICA√á√ÉO.")
    print("Detalhes: Verifique se o Tor est√° completamente conectado e rodando.")
    print(f"Mensagem: {exc}")
except ConnectionRefusedError:
    print(f"\n‚ùå ERRO DE CONEX√ÉO. O script n√£o conseguiu se conectar √† porta de controle do Tor (9051).")
    print("No Tails, tente reiniciar o Tor Browser e execute o script novamente.")
except Exception as e:
    print(f"\n‚ùå ERRO CR√çTICO INESPERADO:")
    print(f"Mensagem: {e}")
