#!/usr/bin/env python3

import csv
import sys
# Vari√°veis para armazenar as classes
CircStatus = None
ControlPort = None
InvalidRequest = None

# Tenta encontrar as classes usando as 3 estruturas mais comuns:
try:
    # 1. Tenta a estrutura moderna (pip)
    from stem.control import ControlPort, InvalidRequest
    from stem import CircStatus
    print("DEBUG: Usando estrutura de importa√ß√£o 'stem.control'.")
except ImportError:
    try:
        # 2. Tenta a estrutura antiga (Debian/apt)
        from stem import CircStatus, ControlPort, InvalidRequest
        print("DEBUG: Usando estrutura de importa√ß√£o 'from stem'.")
    except ImportError:
        try:
            # 3. Tenta a estrutura com importa√ß√£o completa (para compatibilidade total)
            import stem.control
            from stem import CircStatus
            ControlPort = stem.control.ControlPort
            InvalidRequest = stem.control.InvalidRequest
            print("DEBUG: Usando importa√ß√£o de m√≥dulo completo (stem.control.ControlPort).")
        except ImportError:
            # Se todas falharem, o pacote n√£o est√° acess√≠vel
            print("\n‚ùå ERRO FATAL DE IMPORTA√á√ÉO:")
            print("Nenhuma das formas de importar o 'stem' funcionou. O pacote n√£o est√° instalado ou acess√≠vel.")
            print("Aten√ß√£o: Voc√™ instalou com 'sudo apt install python3-stem' e n√£o com 'pip'?")
            sys.exit(1) # Sai do script

# Caminho onde o arquivo CSV ser√° salvo
csv_file_path = "/tmp/circuitos_tor.csv" 

print("Tentando conectar √† porta de controle do Tor...")

try:
    # O script usa as vari√°veis que foram definidas na importa√ß√£o bem-sucedida
    with ControlPort() as control_port: 
        circuit_data = []
        for circuit in control_port.get_circuits():
            
            if circuit.status == CircStatus.BUILT:
                path_str = " -> ".join(
                    f"{entry.nick} ({entry.fingerprint})" for entry in circuit.path
                )
                
                circuit_info = {
                    "id": circuit.id,
                    "status": circuit.status.name, 
                    "path": path_str,
                    "purpose": circuit.purpose.name, 
                }
                circuit_data.append(circuit_info)

        # Escreve os dados no CSV
        if circuit_data:
            keys = circuit_data[0].keys()
            with open(csv_file_path, 'w', newline='', encoding='utf-8') as output_file:
                dict_writer = csv.DictWriter(output_file, fieldnames=keys)
                dict_writer.writeheader()
                dict_writer.writerows(circuit_data)
            
            print(f"\nüéâ SUCESSO! Circuitos exportados para: {csv_file_path}")
            print(f"Total de circuitos exportados: {len(circuit_data)}")
        else:
            print("\n‚ö†Ô∏è NENHUM circuito Tor 'Built' (constru√≠do) ativo foi encontrado.")

# Tratamento de Erros usa a vari√°vel que foi importada (InvalidRequest)
except InvalidRequest as exc: 
    print(f"\n‚ùå ERRO DE COMUNICA√á√ÉO. Verifique o Tor e as permiss√µes.")
    print(f"Mensagem: {exc}")
except ConnectionRefusedError:
    print(f"\n‚ùå ERRO DE CONEX√ÉO. O script n√£o conseguiu se conectar √† porta de controle do Tor (9051).")
    print("Certifique-se de que o Tor est√° rodando.")
except Exception as e:
    print(f"\n‚ùå Ocorreu um erro inesperado (fora da importa√ß√£o): {e}")
