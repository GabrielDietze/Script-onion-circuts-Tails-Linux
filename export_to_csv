#!/usr/bin/env python3

import csv
from stem import CircStatus, ControlPort, InvalidRequest
from stem.util import term

# Caminho onde o arquivo CSV será salvo
csv_file_path = "/home/amnesia/circuitos_tor.csv"

# Conecta à porta de controle do Tor
try:
    with ControlPort() as control_port:
        circuit_data = []
        for circuit in control_port.get_circuits():
            # Coleta informações detalhadas sobre o circuito
            if circuit.status == CircStatus.BUILT:
                path_str = " -> ".join(
                    f"{entry.nick} ({entry.fingerprint})" for entry in circuit.path
                )
                circuit_info = {
                    "id": circuit.id,
                    "status": circuit.status,
                    "path": path_str,
                    "purpose": circuit.purpose,
                }
                circuit_data.append(circuit_info)

        # Escreve os dados no arquivo CSV
        if circuit_data:
            keys = circuit_data[0].keys()
            with open(csv_file_path, 'w', newline='') as output_file:
                dict_writer = csv.DictWriter(output_file, fieldnames=keys)
                dict_writer.writeheader()
                dict_writer.writerows(circuit_data)
            print(f"Dados exportados com sucesso para {csv_file_path}")
        else:
            print("Nenhum circuito Tor ativo encontrado.")

except InvalidRequest as exc:
    print(f"Erro ao conectar à porta de controle: {exc}")

